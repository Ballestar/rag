00:00:00.490 - 00:01:09.540, Speaker A: All right, so in this video, let's talk about the final property we're going to prove about longest chain consensus again under this balanced condition on the leader sequence, namely liveness. So under the balanced condition, it will be the case that any transaction which at some point is known to all of the honest nodes is guaranteed to eventually be finalized, guaranteed to show up not just in a longest chain, but in fact in a longest chain chain then extended by k or more blocks. And remember what we just proved in theorem two. The finality property which is once a transaction is in some block that's K blocks deep on the longest chain, it will forevermore be on the longest chain, k blocks deep. So just as a brief reminder, so remember what the balance condition means w balance, that's a property of a sequence of leaders. So you have honest leaders, you have Byzantine leaders, you have a sequence of H's, and a's W balance just says that if you look at any window of W or more consecutive leaders, it has to be that a strict majority of the leaders in that window are honest. And remember a few videos we saw that if you choose leaders randomly, then you actually will be W balanced for reasonably small W.
00:01:09.540 - 00:01:46.346, Speaker A: You might notice this is the same liveness guarantee we stated for the tenement protocol where a transaction has to be known to all of the honest nodes. That's of course a reasonable assumption. If the honest nodes are sort of running some gossip protocol to exchange the transactions they know about, it is a slightly weaker liveness property than what we proved for our SMR protocol all the way back in Lematu, the one based on rotating leaders in Byzantine broadcast. There we only needed to assume a transaction was known to one honest node. Here we're assuming it's known to all the honest nodes. So we're not going to directly piggyback on theorem one or theorem two. So we need to sort of directly use the hypothesis somewhere that the leader sequence is two K balanced.
00:01:46.346 - 00:02:19.298, Speaker A: So here's how we're going to do that. Let's go back to the beginning of time. So round zero, where there's the genesis block and then leaders keep getting selected each round. So I want you to think about breaking up all the rounds that ever happen into what I'm going to call epics of two K consecutive rounds. So the first two K rounds, that's one epic, the next two K rounds, that's the second epic and so on. So an epic is of course just long enough that the two K balance condition gives us something. So in each epic it must be a strict majority of those two K leaders are honest nodes.
00:02:19.298 - 00:02:51.650, Speaker A: So at least k plus one honest nodes, at most k minus one Byzantine leaders in a given epic. So let's proceed to the counting argument. So the first thing to notice is that whenever you have an honest leader, the longest chain gets longer by one, right? Because that's what honest nodes do. They take the longest chain, or if there's many, they take some longest chain, they add a block to the end. So that makes the longest chain one larger. What about the Byzantine leaders? Well here we can actually rely on assumption a four. And actually we don't even need sort of the full version of a four, which you might remember was in black.
00:02:51.650 - 00:03:22.774, Speaker A: And then you might remember we had the sort of light blue consequence of assumption a four. The light blue consequence is that Byzantine nodes just by assumption cannot add more than one block to any given chain. So whatever the longest chain is, if you look at any Byzantine leader it contributed at most one block to that chain. It may have contributed more blocks to other chains, but to a given longest chain it contributed at most one block. So now let's think about fast forwarding a whole bunch of epics. Let's say a capital T epics. So that's a sequence of two K times capital T leaders in all.
00:03:22.774 - 00:04:11.830, Speaker A: Now each epic has at least K plus one honest leaders. So capital T epics have at least K plus one times T honest leaders. So that means after capital T epics we know the longest chain, whatever it is, it has to have length at least the number of honest leaders, at least quantity K plus one times capital T. Now how many of the blocks on this longest chain could have contributed by, contributed by Byzantine nodes? Well, each epic had at most K minus one Byzantine leaders. And as we noticed, each Byzantine leader can contribute at most one block to any given chain. So of the blocks on the longest chain at most quantity K minus one times capital T could be contributed by Byzantine nodes. And so the difference of course must be made up with blocks that were contributed by honest leaders, by honest nodes.
00:04:11.830 - 00:04:53.158, Speaker A: So after in each epic you're basically going to get another two blocks minimum contributed by honest nodes. So after capital T epics you're going to have at least two times capital T blocks produced by honest nodes appearing in the longest chain, capital T. Remember, that's just a parameter, that's just sort of the number of epics we happen to be looking at. And so as you take time to infinity, as you look at all of the leaders that are ever selected, capital T goes to infinity. So the number of honest blocks on the longest chain also goes to infinity. And so that means honest blocks are added to the longest chain infinitely often. It's true that up to K of these honest blocks may be at the very end of the longest chain and not finalized yet, but the rest are going to be finalized.
00:04:53.158 - 00:05:39.046, Speaker A: So there's going to be at least on the longest chain two capital T minus K finalized blocks. And the important point here is just that two T minus K goes to infinity with T, right? K here, this is just, you know, whatever the parameter is for a balance condition, you know, maybe it's 50 some constant. Capital T is just a parameter. It's just the number of epics from the, from the genesis block that we're looking at. We can choose capital T however we want. So as we let time go to infinity, capital T goes to infinity and we see that the number of finalized blocks on the longest chain contributed by honest nodes, that's also going to infinity. And the only way that's possible is if honestly created blocks get finalized infinitely often.
00:05:39.046 - 00:06:21.590, Speaker A: And so now we're basically done, right? Because one of the responsibilities of honest nodes is when you're selected as a leader, you assemble a single block. And that single block comprises all of the not yet executed transactions that you're aware of. So once this transaction is known to all of the honest nodes, all of them will only be creating blocks that include that transaction at some .1 of those blocks is going to get finalized, right? We've argued that blocks keep getting finalized, honestly produced blocks keep getting finalized infinitely often. And so at that point, this transaction will indeed be, indeed be finalized. And that completes the proof of liveness for longest chain consensus. Again, under this assumption that the leader sequence is balanced.
00:06:21.590 - 00:07:19.122, Speaker A: I do want to say a little bit more about liveness, or specifically potential strengthenings of the liveness statement that we just proved on the last slide. The main reason I'm doing this is to tell you about a measure known as chain quality, which plays a pretty central role in the academic literature analyzing longest chain consensus. So let's brainstorm about some ways we could have a stronger version of theorem three, a stronger sort of liveness statement about longest chain consensus. So one obvious idea is, as we mentioned, that liveness statement was kind of the weaker one that we proved for the tenderman protocol. So we had the stronger hypothesis that all of the nodes know about, all of the honest nodes know about a transaction. And there's a weaker liveness statement that actually held for our sort of rotating leaders byzantine broadcast based SMR protocol in lecture two, where we only needed one honest node to be aware of in a transaction. So you might hope that that stronger liveness statement, so that weaker assumption would also work for longest chain consensus.
00:07:19.122 - 00:08:01.734, Speaker A: But actually it turns out it doesn't. And that's a good exercise for you to think through. If the only thing I tell you about a leader sequence is that it's W balanced for some W, it actually does not guarantee that a transaction known to only one honest node will eventually be included on the longest chain and finalized. The second aspect of theorem three, you might find unsatisfying is it doesn't really give us very concrete bounds on how long someone would have to wait before their transaction gets finalized. Right? All we proved was that eventually a transaction gets finalized. So you could imagine having more quantitative bounds there. Like, exactly how long does someone have to wait? That's actually, frankly, quite interesting to study and there's some nice research papers on exactly that question.
00:08:01.734 - 00:08:56.278, Speaker A: It would just take us like a little bit too far out into the weeds, so we won't discuss that further. But if you're interested, dig into the research literature around longest chain consensus and you can find sort of more concrete quantitative bounds on the finalization time. The third strengthening and the one we're actually going to pursue here, it often goes by the name chain quality. And so here it's related to the quantitative bounds on finalization, but a little bit different. We're going to argue that not only is it the case that infinitely often honestly produced blocks get added to the longest chain and finalized, but actually we're going to really quantify the fraction of the blocks on the longest chain that were contributed by honest nodes. And so in particular, if we only have a guarantee that like 50.1% of the nodes are honest, maybe we can't do much better than the basic liveness statement in theorem three.
00:08:56.278 - 00:09:51.070, Speaker A: But if we actually knew that 60% of the nodes were honest and only 40% were Byzantine, we might hope to be able to quantify the fact that a larger fraction of the blocks on the longest chain presumably were contributed by honest nodes. So let's talk through the stronger guarantee specifically for the case of randomly chosen leaders. So in each round, step two A, one of the end nodes running the protocol is chosen uniformly at random. And again, that's kind of the most relevant form of leader selection for talking about permissionless consensus, which we'll start talking about shortly in lecture nine. The key observation is that if you remember that fourth video where we sort of assumed random leaders and then sort of analyzed how balanced a sequence of random leaders is likely to be. So that was some hard work in that video. And actually, if we go back and review it, the work we did proved a stronger statement than the one that we stated.
00:09:51.070 - 00:10:28.706, Speaker A: So in the notation of that video, we were using alpha to denote the fraction of the nodes that were Byzantine. So alpha fraction, byzantine, one minus alpha honest. We were of course assuming that alpha was strictly less than one half. Otherwise not much you can prove. And what we argued is that for any alpha less than one half, it was the case that a random leader sequence is balanced with high probability and there was some sort of quantitative understanding of the window length you needed in order for that theorem to be true. It depended logarithmically on the sort of duration, capital T you were looking at. Also logarithmically on one over the failure probability you were willing to tolerate.
00:10:28.706 - 00:11:22.978, Speaker A: And then there was a hidden constant which depended on how close alpha, the fraction of Byzantine nodes, how close that was to one half. So unsurprisingly sort of like the less control you have over the fraction of Byzantine nodes, the closer that gets to one half, the longer you're going to have to allow your windows to guarantee that you're w balanced. So that hidden constant in the bound on the window size that was increasing as alpha tended to one half from below. Now, the basic balancedness condition only asserts a strict majority of honest leaders that it's just bigger than 50%. Maybe it's 50.1%, but actually the exact same reasoning from that fourth video of this lecture shows that it's not just that you should have a strict majority for sufficiently large windows. You really should have basically proportional representation of honest nodes in sufficiently large windows.
00:11:22.978 - 00:12:18.994, Speaker A: So if only 51% overall of the honest nodes are honest in any given big window, you're also not expecting much more than 50% to be honest. But if 60% of all of the nodes are honest insufficiently big windows, you should expect close to 60% of those nodes to be honest. Maybe it's 58%, but it should be something well higher than 50%. So let me write down the stronger statement that the argument in the fourth video proved. So if you want, after I write down the statement, you might want to go review that fourth video and just confirm that the exact same reasoning proves the statement I'm going to write down right here. So the statement is going to be an assertion of an upper bound on the failure probability, where for us, a failure means a long window where the fraction of Byzantine leaders in that window is much higher than you'd expect. So with an alpha fraction of Byzantine nodes out there, any given window, you're expecting an alpha fraction of them to be Byzantine.
00:12:18.994 - 00:12:42.334, Speaker A: Of course, sometimes it'll be a little more, sometimes it'll be a little less. And for us, a bad event is that the number of Byzantine liters you actually get in the window is more than an alpha plus epsilon fraction. Again, here alpha is the fraction of nodes that are Byzantine. Here epsilon is a parameter. You can kind of set it to whatever you want. I maybe would encourage you to set it to zero one. So set it to 1% and think about that concrete value.
00:12:42.334 - 00:13:57.238, Speaker A: Now, clearly I haven't completed the statement because I haven't said what little w is, I haven't said what is the window length that we're looking at? Right? If we were looking at windows of length one, then obviously this wouldn't be true. But the hope would be that once the windows are sort of sufficiently big, at that point you're going to have basically proportional representation of honest and Byzantine leaders so the question then is how big does little W need to be before that's the case? And the bound is actually the exact same one that we had in the fourth video. So again, logarithmic dependence on the duration that you're looking at and also logarithmic dependence on one over the failure probability here, c is a constant which is going to depend on epsilon. So the smaller epsilon is sort of the closer to exact proportional representation you're insisting on. And so the bigger you're going to need to take the window length to get such sharp guarantees. So c is getting bigger, as epsilon is going to zero for epsilon fixed at like zero one, you're going to have some concrete constant C. And so the statement we proved back in the fourth video, sort of the basic statement about the balancedness condition, basically, we were doing this statement where alpha was like 49% and epsilon was 1%.
00:13:57.238 - 00:14:31.502, Speaker A: It's basically the special case that we did. But the exact same argument, the exact same reasoning proves this stronger statement that you're only going to be off by epsilon from what you expect in any sufficiently large window. Let's go ahead and give this condition a name. Let's call this w comma alpha plus epsilon balanced. Instead of just w balanced. We're now also going to incorporate sort of the fraction of Byzantine nodes that we're willing to tolerate. So our original balance condition, so w balance, that corresponds to w comma one half balanced.
00:14:31.502 - 00:15:26.638, Speaker A: And the blue statement sort of the consequence of our probabilistic analysis that says that leader sequences are w alpha plus epsilon balanced, where W is as shown in green on the right of the slide with high probability, with high probability meaning probability close to one, at least one minus delta, where delta is a tunable failure probability. Think of that maybe also as say, 1%. So now for the statement of this stronger liveness result, the chain quality result, let's call it theorem three prime in homage to our liveness result, theorem three. So here we're going to have a stronger hypothesis. We're going to assume that the leader sequence is not merely balanced, but actually alpha plus epsilon balanced. Here, remember, alpha is the fraction of nodes that are assumed to be Byzantine. And epsilon is kind of the extra error we're going to allow in the representation of Byzantine nodes in any length, in this case, length two k window.
00:15:26.638 - 00:16:33.844, Speaker A: Under this stronger hypothesis, we will be able to assert a lower bound on the fraction of the blocks that get finalized which were produced by honest nodes. That fraction is going to be modulus of epsilons one minus two alpha divided by one minus alpha. For this expression in light blue, to be positive, it must be that the numerator is positive one minus two alpha minus two epsilon. And that's going to be positive only if and only if alpha plus epsilon is strictly less than one half. You will notice that as alpha plus epsilon approaches one half from below, the ratio in light blue is tending to zero. And I encourage you to think of our initial liveness result, theorem three, as kind of the special case of theorem three prime, where it just so happens that alpha plus epsilon is very, very close to one half, just slightly less than one half. That corresponds to sort of our old hypothesis, right, basically allowing 49% of the nodes to be Byzantine.
00:16:33.844 - 00:17:08.084, Speaker A: Think of taking epsilon to be slightly less than 1%. But then the conclusion is only that there exists infinitely often honest blocks on the longest chain. So here we have the stronger assumption, perhaps the fraction of Byzantine nodes, alpha is sort of, well, less than one half, maybe it's only 40%, something like that. And then we're getting a stronger conclusion as well. We're getting a stronger lower bound on the representation of honestly produced blocks on the longest chain. The proof of theorem three prime mimics quite closely the proof of theorem three. Basically the same counting argument is going to work for us.
00:17:08.084 - 00:17:54.388, Speaker A: So let me just kind of mention what the key points are and then we'll see where this ratio comes from. So we're going to again think about sort of some large number of epics. Remember, an epic is two K liters in a row so that we can invoke the balancedness condition. And then we're going to look at capital T epics where capital T is going to infinity. And let's count sort of the number of honest leaders in this sequence. Well, by our assumed balancedness condition in each of those epics, in each consecutive block of two K liters, we know that at most an alpha plus epsilon fraction are Byzantine, right? That's what the assumption means. So turning that around, we can say that at least one minus alpha minus epsilon fraction of each epic is going to be honest.
00:17:54.388 - 00:18:25.390, Speaker A: So in each of the capital T epics we contribute the length of the epic, two K times that fraction. One minus epsilon minus one minus alpha minus epsilon. That's the lower bound on the number of honest blocks. Number of honest leaders over capital T epics. As we noted in the proof of theorem three, every honest leader adds one to the length of the longest chain. So. In particular, with this many honest leaders, the longest chain after capital T epics, must itself have length at least two k times one minus alpha minus epsilon times capital T.
00:18:25.390 - 00:19:20.480, Speaker A: We also saw in the proof of theorem three, using our assumption a four, each Byzantine leader can only contribute one block at most to the longest chain. So how many Byzantine leaders could we have had over these capital T epics? Well, it's just the number of epics, capital T times the length of an epic, two times K times the fraction of nodes that might be Byzantine, which is at most alpha plus epsilon. So now we're in a position to lower bound the fraction of blocks in the longest chain that were honestly produced. We just take our lower bound on the total number of blocks, so that's our two K, one minus alpha minus epsilon times T. We subtract the number of those that might have been contributed by Byzantine leaders. That's the two K quantity alpha plus epsilon times T divided by the total number of blocks, which is just that same number. Again, two K, one minus alpha minus epsilon times T.
00:19:20.480 - 00:20:08.554, Speaker A: Like any good proof, we get some satisfying cancellations. The two K's and the capital T's all drop out. And then when the dust settles, we get the promised ratio, one minus two alpha minus two epsilon over one minus alpha minus epsilon. And so that is the proof of the basic chain quality results for longest chain consensus. If an alpha fraction of the nodes are Byzantine, then you get a guarantee of basically one minus two alpha over one minus alpha of the fraction of the longest chain contributed by honestly produced blocks. So how should we feel about this ratio? Is this a good ratio? Well, as alpha goes to zero, as there's less and less Byzantine nodes, I mean, this ratio is going to go to one. So that's good.
00:20:08.554 - 00:20:42.878, Speaker A: So the fraction of honest blocks approaches 100% as the fraction of Byzantine nodes approaches zero. But if you think about intermediate values of alpha, you could imagine being sort of disappointed actually with this ratio. Like, imagine you had alpha equal a third. So two thirds of the nodes were honest, one third of the nodes were Byzantine. You might hope that honest nodes would get their fair share of blocks on the longest chain, which would be two thirds of the longest chain. That's not what this ratio is, right? If alpha equals a third, then this is going to be one minus two alpha. So one minus two thirds.
00:20:42.878 - 00:21:18.482, Speaker A: So that's one third on top and then one minus one third, which is two thirds on the bottom. So one third over two thirds, that's also known as one half. In other words, if a third of the nodes are Byzantine, according to this analysis, it doesn't rule out that they might capture half of the blocks on the longest chain, which seems kind of unfair, right? Two thirds of the nodes are honest, and somehow they're only getting 50% of the slots on the longest chain. So you might wonder if this is kind of an artifact of the proof. Maybe we're being stupid. A smarter proof would give us the sort of one minus alpha fraction that we might hope for. But in fact, we'll see that's not the case.
00:21:18.482 - 00:22:21.894, Speaker A: We'll see that actually one minus two alpha over one minus alpha is exactly the right answer for the chain quality, at least under our assumptions of Byzantine behavior and arbitrary tiebreaking by honest nodes, we will actually see that in a different context, in the context of selfish mining in lecture number ten. So this ratio, one minus two alpha over one minus alpha, that will be showing up, again, two lectures. Hence, I should also mention that there are ways, at least in principle, to add some additional complexity to the basic longest chain consensus protocol we've seen here. In order to boost the chain quality, in particular, to boost it from this guarantee of one minus two alpha over one minus alpha, boost it up to where you'd really like it to be, which is one minus alpha or very close to thereabouts. So there are a couple of research papers that have outlined how you could do that. I'll put citations to them in the lecture notes that accompany this lecture. Lecture eight.
00:22:21.894 - 00:23:03.090, Speaker A: As far as I know, those solutions have sort of just remained research projects. I'm not aware of a practical deployment. As far as I know, at least, all of the major longest chain consensus protocols that are out there and deployed, all of them have only this weaker chain quality guarantee of one minus two alpha over one minus alpha. So that wraps up our final proof of lecture eight. These are all of the guarantees I wanted to tell you about of longest chain consensus. So if you have less than 50% Byzantine nodes, you get the common prefix property, you get consistency, you get liveness, and then you get the stronger form of liveness. This chain quality guarantee that we saw on this slide.
00:23:03.090 - 00:23:55.054, Speaker A: There is going to be one final video for lecture eight. And the main thing I want to do in that video is probe what happens to longest chain consensus when we relax the assumptions on the communication network. As we've mentioned many times, for convenience, we've been using this instantaneous communication model, the supersynchronous model. But all of the results extend with just a tiny bit of loss to the general synchronous model, provided the length of a round is large relative to the maximum message delay delta. But what about the partially synchronous model? So we'll do that in the next video. We'll investigate eight the ways in which longest chain consensus breaks down when you actually can have unbounded network delays. Also in the next video, I'll highlight what are the key takeaway points from this rather long lecture eight that you should remember going forward in the lecture series.
00:23:55.054 - 00:23:56.830, Speaker A: So I'll see you there. Bye.
